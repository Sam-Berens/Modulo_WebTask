<!DOCTYPE html>
<html>
<head>
<title>Spark Training</title>

<!--- NOTE FOR WHEN YOU RETURN TOMORROW: I am trying to add the bits for  'jsPsych.run([PreloadImgs,EnterFullscreen,TrialLoop,ExitFullscreen]);'
so I can do this thing 'GetTimelineVars().then(function(P2){'-->




<!-- Get jQuery -->
<script src="./Assets/jquery.min.js"></script>

<!-- Set the favicon logo -->
<link rel="icon" href="./Logo.png" type="image/x-icon" />

<!-- Unpack the main JSpsych module -->
<script src="https://unpkg.com/jspsych@7.3.3"></script>

<!-- JSpsych dependency to fullscreen -->
<script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>

<!-- JSpsych dependency for HTML button response -->
<script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
<script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
<!-- JSpsych dependency for preloading -->
<script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>



<!-- JSpsych dependency for styling -->
<link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" />


    
<!-- More styling -->
<style>
body{background-color:black;}
[id^=x]:hover {border: 1px solid #00ffff;border-radius: 25px;width: 248px}
</style>

<script src="./RandomTools/Rng.js"></script>
<script src="./RandomTools/Shuffle.js"></script>
<script src="./PairAssignments.js"></script> 


<!-- Get participant IDs passed in from URL -->
<script src="./Assets/GetPpantIds.js"></script>  <!--i need to have an index page which is where the ppid gets generated!-->

<!-- Exclusion check -->
<script src= "./Assets/ExclusionCheck.js"></script>

<!-- Get jQuery -->
<script src= "./Assets/jquery.min.js"></script>

<!-- Get DateTime_Start and ClientTimeZone (and add to TaskIO)  -->
<script src= "./Assets/SetDateTime.js"></script>

<!-- this bit is for saving data-->
<script>

// --- Write TaskIO to server --- 
function WriteTaskIO(Flag){
    var JsonPost = {
        type: "POST",
        url: './WriteXIO.php',
        dataType: 'json',
        data: {FunctionCall: 'WriteTaskIO', Args: {
			SubjectId: SubjectId,
            Flag: Flag, // -1=BonkedOut, 0=PartSave, 1=FinalSave;
			ClientTimeZone: ClientTimeZone,
			TaskIO: JSON.stringify(TaskIO)
			}},
        success: function (Obj,Textstatus) {
            if( !('error' in Obj) ) {
                  return Obj.result;
              }
        }
    }
    Response = jQuery.ajax(JsonPost);
    return new Promise(resolve => {resolve(Response)});
}

// Import the main jsPsych object
const jsPsych = initJsPsych({
    on_finish: function() {
        var P1 = WriteTaskIO().then(function(P1) {
            TargetUrl = P1.TargetUrl; // what does this bit do?? is it like it stops the particpant proceeding to the task without having Task IO setup by changing the url
            window.location.replace(TargetUrl);
        }).catch(function(Err) {
            alert('An error has occurred.\nPlease report error code #200 to the experimenter:\n'+Err);
            //window.location.replace("./Error.html");
        });
    }
});


// --- TaskIO SETUP ---

var TaskIO = {};
TaskIO.SubjectId = null;
TaskIO.DateTime_Start = null;
TaskIO.ClientTimeZone = null;
TaskIO.Pairs = {};  //change this one <!-- I need to adapt a script to get the question IDs? -->
TaskIO.Trials = [];



//PRELOAD IMGS

var PreloadImgs = {                               /// does this work when the images are being called as a tag not just the filename on its own?
    type: jsPsychPreload,
    images: [
    './TestShapes/A.jpg',
    './TestShapes/B.jpg',
    './TestShapes/C.jpg',
    './TestShapes/D.jpg',
    './TestShapes/E.jpg',
    './TestShapes/F.jpg',
    './TestShapes/G.jpg'
    ]
};
    


// master array of sparks

var ArrayOfImgs = [
	{FeildId:'A',CueTag:'<img src="./TestShapes/A.jpg" width="400px" id="yA">', ResponseTag: '<img src="./TestShapes/A.jpg" width="280px" id="xA" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'B',CueTag:'<img src="./TestShapes/B.jpg" width="400px" id="yB">', ResponseTag: '<img src="./TestShapes/B.jpg" width="280px" id="xB" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'C',CueTag:'<img src="./TestShapes/C.jpg" width="400px" id="yC">', ResponseTag: '<img src="./TestShapes/C.jpg" width="280px" id="xC" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'D',CueTag:'<img src="./TestShapes/D.jpg" width="400px" id="yD">', ResponseTag: '<img src="./TestShapes/D.jpg" width="280px" id="xD" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'E',CueTag:'<img src="./TestShapes/E.jpg" width="400px" id="yE">', ResponseTag: '<img src="./TestShapes/E.jpg" width="280px" id="xE" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'F',CueTag:'<img src="./TestShapes/F.jpg" width="400px" id="yF">', ResponseTag: '<img src="./TestShapes/F.jpg" width="280px" id="xF" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'G',CueTag:'<img src="./TestShapes/G.jpg" width="400px" id="yG">', ResponseTag: '<img src="./TestShapes/G.jpg" width="280px" id="xG" onclick="javascript:ImgClicked(this.id)">'}
];

function ImgClicked(Id) {
    var lastTrialData = jsPsych.data.getLastTrialData().values()[0];
    var correctResponse = jsPsych.timelineVariable('FnC');                             // This should now contain the correct_response_trial value

    console.log("Clicked image ID:", Id);
    console.log("Correct response:", correctResponse);
}

// from this we extract the two sub arrays, first response tags:


var ArrayOfResponseTags = ArrayOfImgs.map(function(obj){
	return obj.ResponseTag;
});
 

// now we extract the cue tags from the master array and make the question array:
 var ArrayOfCueTags = ArrayOfImgs.map(function(obj){
	return obj.CueTag;
});


// the following variables are either going into the running order at the very end or the Trial Loop
// Specifiy the EnterFullscreen event
var EnterFullscreen = {
	type: jsPsychFullscreen,
	message: '<p style="color:white;">The task is ready to begin.</p><p style="color:white;">Please click the button below to continue.</p>',
	fullscreen_mode: true,
	delay_after: 1000,
	on_finish: function() {EnforceUnfocus = true;}
 };

// Specifiy the ExitFullscreen event
var ExitFullscreen = {
	type: jsPsychFullscreen,
	fullscreen_mode: false,
	on_finish: function() {EnforceUnfocus = false;}
 };

// Specifiy the Fixation event
var Fixation = {
	type: jsPsychHtmlButtonResponse,
	stimulus: '<p><font color="#ffffff" size="30px">+</font></p>',
	choices: [],
	prompt: "",
	trial_duration: 1000
};

var Show_qA = {
	type: jsPsychHtmlButtonResponse,
	stimulus: function() {return jsPsych.timelineVariable('FnA')},
	choices: [],
	prompt: [],
	trial_duration: 1000
};

var Show_qB = {
	type: jsPsychHtmlButtonResponse,
	stimulus: function() {return jsPsych.timelineVariable('FnB')},
	choices: [],
	prompt: [],
	trial_duration: 1000
};

var StartTime_ResponsePrompt = NaN;
var ResponsePrompt = {
	type: jsPsychHtmlButtonResponse,
	stimulus: SparkOptions,
    choices: [],
	data: {
    task: 'response',
    correct_response: jsPsych.timelineVariable('FnC'),
	response: ImgClicked
  },
	prompt: [],
	trial_duration: 3000,
	on_start: function() {
		StartTime_ResponsePrompt = jsPsych.getTotalTime()},                //////////NOTE FOR WHEN YOU COME BACK: HOW CAN WE REARRANGE THIS WITH IMG CLICKED SO IT PUTS WHATEVER ITS DOING ON THE START OF THE TRIAL INTO THE CLICK
	
};
	

// Specify the Feedback event
var Feedback = {
	
	type: jsPsychHtmlButtonResponse,
	
	// Set the feedback to display   
	stimulus: function() {
		if(ResponseMade) {
			if(Correct){
				return '<p style="vertical-align:middle; margin: 0px 5px 30px; color:#00ff00; font-size:120px">&#10003;</p>';
			} else {
				return '<p style="vertical-align:middle; margin: 0px 5px 30px; color:#ff0000; font-size:120px">&#10060;</p>';
			}
		} else {
			return '<p style="vertical-align:middle;color:#ff0000;font-size:30px">Please try to respond on time!</p>';
		}
	},
	
	// Set the choices and prompt fields to be empty (we don't use them)
	choices: [],
	prompt: "",
    
	// Set the feedback duration (depends on whether a response was made)
	trial_duration: function() {
		if (ResponseMade) {
			return 3000;
		} else {
			return 5000;
		}
	}
};

// define the SparkOptions function outside of the timeline - We want this shuffle to happen outside of the .then function
function SparkOptions(){
	var HtmlString = Shuffle(ArrayOfResponseTags).toString(); // Get the shuffled array and turn into string;
	HtmlString = '<table style="width:95%;text-align:center;"> <tbody><tr> <td>' + HtmlString // Get the suffled array and turn into string;
	HtmlString = HtmlString.replace(',' , '</td> <td colspan="2">'); // Column seperators between images;  style = "align=centre;"
	HtmlString = HtmlString.replace(',' , '</td><td>'); // Column seperators between images;
	HtmlString = HtmlString.replace(',' , '</td></tr><tr><td>'); // Column seperator and then new row ?;
	HtmlString = HtmlString.replace(',' , '</td><td>'); // new row and then column seperators between images;
	HtmlString = HtmlString.replace(',' , '</td><td>'); // Column seperators between images;
	HtmlString = HtmlString.replace(',' , '</td><td>'); // Column seperators between images
	HtmlString = HtmlString + '</td></tr></tbody></table>'; // Close the table
	return HtmlString
}



//this bit specifies the trial loop and also makes jspych wait for the seed before running everything        
// for the trial 2,3 and 5 it takes first line of vArrayOfQs and say stimulus is timelineVaribale where its the value of A, the value of B, and then the value of C

//we make array of Qs which we're about to push the participants individual question allocation into along with the file names from ArrayofCueTags
var TimelineVars = [];
SeedRng().then(function(P1) {
	
	for (let i = 0; i < Sup.length; i++) {
		var PairId = Sup[i];
		var qA = Sup[i] % 7;
		var qB = Math.floor(Sup[i]/7);
		var qC = (qA * qB) % 7 ;
		var FnA = ArrayOfCueTags[qA];
		var FnB = ArrayOfCueTags[qB];
		var FnC = ArrayOfCueTags[qC];
		var TrialObj = {qA: qA, qB: qB, qC: qC, FnA: FnA, FnB: FnB, FnC: FnC};
		TimelineVars.push(TrialObj);
	}
	Shuffle(TimelineVars);
	
	

	//// specify the Trial structure ( qA, qB, SparkOptions page)
	var TrialLoop = {
		timeline: [Fixation,Show_qA,Show_qB,ResponsePrompt],
		timeline_variables: TimelineVars,
		randomize_order: false
	};
	
	
	
	jsPsych.run([PreloadImgs,EnterFullscreen,TrialLoop,ExitFullscreen]);
});
</script>
</head>
<body>
</body>
</html>