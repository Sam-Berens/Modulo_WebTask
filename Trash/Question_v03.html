<!DOCTYPE html>
<html>
<head>
<title>Spark Training</title>


<!-- Get jQuery -->
<script src="./Assets/jquery.min.js"></script>

<!-- Set the favicon logo -->
<link rel="icon" href="./Logo.png" type="image/x-icon" />

<!-- Unpack the main JSpsych module -->
<script src="https://unpkg.com/jspsych@7.3.3"></script>

<!-- JSpsych dependency to fullscreen -->
<script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>

<!-- JSpsych dependency for call-function -->
<script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>

<!-- JSpsych dependency for HTML button response -->
<script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
<script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>

<!-- JSpsych dependency for preloading -->
<script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>

<!-- JSpsych dependency for styling -->
<link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" />


<!-- Dynamic border + black background -->
<style>
body{background-color:black;}
[id^=Resp]:hover {border: 1px solid #00ffff;border-radius: 25px;width: 148px}
</style>

<script src="./RandomTools/Rng.js"></script>
<script src="./RandomTools/Shuffle.js"></script>
<script src="./PairAssignments.js"></script> 

<!-- Get participant IDs passed in from URL -->
<script src="./Assets/GetPpantIds.js"></script>  <!--i need to have an index page which is where the ppid gets generated!-->

<!-- Exclusion check -->
<!-- <script src= "./Assets/ExclusionCheck.js"></script> -->

<!-- Get jQuery -->
<script src= "./Assets/jquery.min.js"></script>

<!-- Get DateTime_Start and ClientTimeZone (and add to TaskIO)  -->
<script src= "./Assets/SetDateTime.js"></script>

<!-- Main script block -->
<script>

// Function to convert FeildIdx to filenames
var FeildPermutation = [4,2,3,1,0,5,6];
function FeildIdx2ImgName(FeildIdx) {
	var ImgName = './TestShapes/i'+FeildPermutation.indexOf(FeildIdx).toString().padStart(2,'0')+'.jpg';
	return ImgName;
}


// here I'm going to make an array of the two symbols which we can put into timeline variables
// and then a Function to convert FeildIdx to filenames
/*var SymbolId = [0,1];
function SymbolId2ImgName(SymbolId) {
		var ImgName = './symbols/s'+ SymbolId.indexOf().toString().padStart(2,'0')+'.png';
		return ImgName;
} */


// Construct the ArrayOfResponseTags
var ArrayOfResponseTags = [];
function PopulateArrayOfResponseTags() {
	for (var FeildIdx = 0; FeildIdx < 7; FeildIdx++) {
		var ImgName = FeildIdx2ImgName(FeildIdx);
		var ResponseTag = 
			'<img src="' + ImgName + 
			'" width="150px" id="Resp_' + FeildIdx.toString().padStart(2,'0') + 
			'" onclick="javascript:ImgClicked(this.id)">';
		ArrayOfResponseTags.push(ResponseTag);
	}
}
PopulateArrayOfResponseTags();

// Construct the TimelineVars
var TimelineVars = [];
function PopulateTimelineVars() {

	// Supervised pairs
	for (var i = 0; i < Sup.length; i++) {
		var PairId = Sup[i];
		var FeildIdx_A = PairId % 7;
		var FeildIdx_B = Math.floor(PairId/7) % 7;
		var OppIdx = Math.floor(PairId/49);
		var FeildIdx_C = Ans[PairId];
		var Fn_A = FeildIdx2ImgName(FeildIdx_A);
		var Fn_B = FeildIdx2ImgName(FeildIdx_B);
		var Fn_C = FeildIdx2ImgName(FeildIdx_C);
		var Fn_S = Sym[OppIdx]; 
		var TrialObj = {
			TrialType: 'Sup',
			OppId: OppIdx,
			PairId: PairId,
			FeildIdx_A: FeildIdx_A,
			FeildIdx_B: FeildIdx_B,
			FeildIdx_C: FeildIdx_C,
			Fn_S: Fn_S,
			Fn_A: Fn_A,
			Fn_B: Fn_B,
			Fn_C: Fn_C};
		TimelineVars.push(TrialObj);
		
		// THIS BIT BELOW IS A GUESS AT HOW TO ADD ON THE QUESTIONS FOR THE SECOND SYMBOL (IE DIVISION) - 
		// Sup2 = the second array with all the division questions in (would this be identical to original Sup? and then ?Would we repeat process for Unsup?
		// For now I'm refering to the two sparks in the question and the answer spark as D, E and F (since A,B,C are taken)
		// symbolId 0 is multiplicaiton and symbolId 1 is division 
		
	/*/function PopulateTimelineVars2() {
	for (let i = 0; i < Sup2.length; i++) {
		var PairId = Sup2[i];
		var FeildIdx_D = PairId % 7;
		var FeildIdx_E = Math.floor(PairId/7);
		var FeildIdx_F = (FeildIdx_D / FeildIdx_E) % 7 ;
		var Fn_D = FeildIdx2ImgName(FeildIdx_D);
		var Fn_E = FeildIdx2ImgName(FeildIdx_E);
		var Fn_F = FeildIdx2ImgName(FeildIdx_F);
		var Fn_S = './symbols/s00.png';
		var TrialObj = {
			SymbolId: 1,
			Fn_S: Fn_S,
			FeildIdx_D: FeildIdx_D,
			FeildIdx_E: FeildIdx_E,
			FeildIdx_F: FeildIdx_F,
			Fn_D: Fn_D,
			Fn_E: Fn_E,
			Fn_F: Fn_F};
		TimelineVars.push(TrialObj); 
	} */
	}
	
	// Unsupervised pairs:
	for (let i = 0; i < Uns.length; i++) {
		var PairId = Uns[i];
		var FeildIdx_A = PairId % 7;
		var FeildIdx_B = Math.floor(PairId/7) % 7;
		var OppIdx = Math.floor(PairId/49);
		var FeildIdx_C = Ans[PairId];
		var Fn_A = FeildIdx2ImgName(FeildIdx_A);
		var Fn_B = FeildIdx2ImgName(FeildIdx_B);
		var Fn_C = FeildIdx2ImgName(FeildIdx_C);
		var Fn_S = Sym[OppIdx]; 
		var TrialObj = {
			TrialType: 'Uns',
			OppId: OppIdx,
			PairId: PairId,
			FeildIdx_A: FeildIdx_A,
			FeildIdx_B: FeildIdx_B,
			FeildIdx_C: FeildIdx_C,
			Fn_S: Fn_S,
			Fn_A: Fn_A,
			Fn_B: Fn_B,
			Fn_C: Fn_C};
		TimelineVars.push(TrialObj);
	}
}
PopulateTimelineVars();


function GetFullQuestion() {
	//'<style type="text/css"> .tg  '+
	//'{border-collapse:collapse;border-color:white;border-spacing:0;border-style:solid;border-width:1px;margin:0px auto;} '+
	//'tg td{border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:5px;overflow:visible; padding:10px 5px;word-break:normal;}'+
	//' .tg th{border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:9px;font-weight:normal; '+
	//'overflow:visible;padding:10px 5px;word-break:normal;} .tg .tg-ofx2{ border-color:#efefef; color:#ffffff; text-align:left;vertical-align:top} '+
	//'</style> <table class="tg"> <thead> <tr> <td class="tg-ofx2">  "symbol"   </td> <td class="tg-ofx2" > '+
	//'<img src="'+ GetQuestion() +'" width="400px"> </td> <td class="tg-ofx2"> <img src= "' + GetQuestion(true) 
	//+ '" width="100px"> </td></tr></thead></table></h1>' + HtmlString
	var HtmlString = '<table style="width:33%;text-align:center;border:1px solid white;" align="center"><tbody><tr>'+
		'<td><img src="'+jsPsych.timelineVariable('Fn_S',true)+'" width="100px">'+'</td>'+
		'<td><img src="'+jsPsych.timelineVariable('Fn_A',true)+'" width="100px"></td>'+
		'<td><img src="'+jsPsych.timelineVariable('Fn_B',true)+'" width="100px"></td>'+
		'</tr></tbody></table>';
	return HtmlString;
}

// This is a stimulus function that is directly called by jsPsych ...
// ... having been referenced in the Response trial object
function GetSparkOptions(){
	var HtmlString = Shuffle(ArrayOfResponseTags).toString(); // Get the shuffled array and turn into string;
	HtmlString =  '<table style="width:100%;text-align:center;"> <tbody><tr> <td colspan="4" align="center"> <table><tr><td>' + HtmlString; // Get the suffled array and turn into string;
	HtmlString = HtmlString.replace(',' , '</td> <td>'); // Column seperators between images;  style = "align=centre;"
	HtmlString = HtmlString.replace(',' , '</td><td>'); // Column seperators between images;
	HtmlString = HtmlString.replace(',' , '</td></tr></table><tr><td>'); // Column seperator and then new row ?;
	HtmlString = HtmlString.replace(',' , '</td><td>'); // new row and then column seperators between images;
	HtmlString = HtmlString.replace(',' , '</td><td>'); // Column seperators between images;
	HtmlString = HtmlString.replace(',' , '</td><td>'); // Column seperators between images
	HtmlString = HtmlString + '</td></tr></tbody></table>'; // Close the table. BELOW I AM ADDING THE SECOND TABLE WHICH IS THE QUESTION BAR AT THE TOP
	return HtmlString;
}

// Import the main jsPsych object
var jsPsych = initJsPsych({
	on_finish: function() {
		jsPsych.data.displayData();
	}
});

// Helper function: Sleep()
function Sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

var SessionId = 78; /////////////////////////////////////////////////////////////////////////////////////////////////////////
async function ImgClicked(Id) {

	// If we are not accepting responses, return the function i.e., don't do anything further)
	if (!AcceptResponse) {return;}
	
	// Increment the attempt number:
	AttemptNum = AttemptNum + 1;
	
	// Specify the TrialType, FeildId, Correct, and RT variables
	var TrialType = jsPsych.timelineVariable('TrialType',true);
	var FeildIdx_Response = parseInt(Id.slice(-2));
	var Correct = FeildIdx_Response === jsPsych.timelineVariable('FeildIdx_C',true);
	var RT = jsPsych.getTotalTime() - StartTime_ResponsePrompt;
	console.log(Correct,RT);
	
	// Do not provide feedback, or save any data, if the response came more than 2 mins after the response window started
	if (RT > (2*60*1000)) {
		window.location.reload();
		return;
	}
	
	// Save the data:
	var DataToSend = {};
	DataToSend.SubjectId = SubjectId;
	DataToSend.SessionId = SessionId;
	DataToSend.TrialId = TrialId;
	DataToSend.PairId = jsPsych.timelineVariable('PairId',true);
	DataToSend.TrialType = TrialType;
	DataToSend.OppId = jsPsych.timelineVariable('OppId',true);
	DataToSend.FeildIdx_A = jsPsych.timelineVariable('FeildIdx_A',true);
	DataToSend.FeildIdx_B = jsPsych.timelineVariable('FeildIdx_B',true);
	DataToSend.FeildIdx_C = jsPsych.timelineVariable('FeildIdx_C',true);
	DataToSend.AttemptNum = AttemptNum;
	DataToSend.FeildIdx_R = FeildIdx_Response;
	if (Correct) { 
	    DataToSend.Correct = 1;
	} else {
	    DataToSend.Correct = 0;    
	}
	DataToSend.RT = RT;
	
	//Send data to php script
	fetch('./WriteTaskIO.php', {
        method: 'post',
        headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
        body: JSON.stringify(DataToSend)
    });
	
	
	
	// Colour the boarders and end the trial (if we need to):
	if (TrialType==='Sup') {
		if (!Correct) {
			document.getElementById(Id).style = "border: 1px solid #ff0000;border-radius: 25px;width: 148px";
			///////////////
		} else {
			// Set AcceptResponse to be false:
			AcceptResponse = false;
			
			// Set the current (correct) response to have a green border:
			document.getElementById(Id).style = "border: 1px solid #00ff00;border-radius: 25px;width: 148px";
			
			// --- Set all other responses to have a black border ---
			// Identify the FeildIdxs to turn black:
			var Idxs = [0,1,2,3,4,5,6];
			Idxs = Idxs.filter(function(x) {
				if (x!== FeildIdx_Response) {
					return true;
				} else {
					return false;
				}
			});
			// Loop over those FeildIdxs:
			for (var i = 0; i < Idxs.length; i++) {
				var Ids2change = 'Resp_'+ Idxs[i].toString().padStart(2,'0');
				document.getElementById(Ids2change).style = "border: 1px solid #000000;border-radius: 25px;width: 148px";
			}
			
			// Sleep for 1 second:
			await Sleep(1000);
			
			// End the trial:
			jsPsych.finishTrial();
		}
	} else {
		// Set AcceptResponse to be false:
		AcceptResponse = false;
		
		// Set the current (correct) response to have a green border:
		document.getElementById(Id).style = "border: 1px solid #0000ff;border-radius: 25px;width: 148px";
		
		// --- Set all other responses to have a black border ---
		// Identify the FeildIdxs to turn black:
		var Idxs = [0,1,2,3,4,5,6];
		Idxs = Idxs.filter(function(x) {
			if (x!== FeildIdx_Response) {
				return true;
			} else {
				return false;
			}
		});
		// Loop over those FeildIdxs:
		for (var i = 0; i < Idxs.length; i++) {
			var Ids2change = 'Resp_'+ Idxs[i].toString().padStart(2,'0');
			document.getElementById(Ids2change).style = "border: 1px solid #000000;border-radius: 25px;width: 148px";
		}
		
		// Sleep for 1 second:
		await Sleep(1000);
		
		// End the trial:
		jsPsych.finishTrial();	
	}
}


// Preload jsPsych object
var PreloadImgs = {
    type: jsPsychPreload,
    images: [
    './TestShapes/i00.jpg',
    './TestShapes/i01.jpg',
    './TestShapes/i02.jpg',
    './TestShapes/i03.jpg',
    './TestShapes/i04.jpg',
    './TestShapes/i05.jpg',
    './TestShapes/i06.jpg'
    ]
};

var PreloadSymbols = {
	type: jsPsychPreload,
	images: [
	'./symbols/s00.png',
	'./symbols/s01.png'
	]
};
	

// the following variables are either going into the running order at the very end or the Trial Loop
// Specifiy the EnterFullscreen event
var EnterFullscreen = {
	type: jsPsychFullscreen,
	message: '<p style="color:white;">The task is ready to begin.</p><p style="color:white;">Please click the button below to continue.</p>',
	fullscreen_mode: true,
	delay_after: 1000,
	on_finish: function() {EnforceUnfocus = true;}
 };

// Specifiy the ExitFullscreen event
var ExitFullscreen = {
	type: jsPsychFullscreen,
	fullscreen_mode: false,
	on_finish: function() {EnforceUnfocus = false;}
 };
 
// Set some gloabl variables:
var TrialId = -1;
var AttemptNum = -1;
var AcceptResponse = true;
var PreTrialOps = {
	type: jsPsychCallFunction,
	func: function() { 
	    TrialId = TrialId + 1;
	    AttemptNum = -1
	    AcceptResponse = true;
	}
};

// Specifiy the Fixation event
var Fixation = {
	type: jsPsychHtmlButtonResponse,
	stimulus: '<p><font color="#ffffff" size="30px">+</font></p>',
	choices: [],
	prompt: "",
	trial_duration: 1000
};

// Trial object that presents the trial symbol
var Show_S = {
	type: jsPsychHtmlButtonResponse,
	stimulus: function() {
		var Fn = jsPsych.timelineVariable('Fn_S');
		var Tag = '<img src="'+Fn+'" width="200px"';
		return Tag;
	},
	choices: [],
	prompt: [],
	trial_duration: 1000
};

// Trial object that presents the A cue
var Show_A = {
	type: jsPsychHtmlButtonResponse,
	stimulus: function() {
		var FeildIdx = jsPsych.timelineVariable('FeildIdx_A');
		var Fn = jsPsych.timelineVariable('Fn_A');
		var Tag = '<img src="'+Fn+'" width="400px" id="Cue_'+FeildIdx.toString().padStart(2,'0')+'"';
		return Tag;
	},
	choices: [],
	prompt: [],
	trial_duration: 1000
};

// Specifiy the Inter-cue-iterval event
var ICI = {
	type: jsPsychHtmlButtonResponse,
	stimulus: '<p><font color="#ffffff" size="30px">+</font></p>',
	choices: [],
	prompt: "",
	trial_duration: 200
};

// Trial object that presents the B cue
var Show_B = {
	type: jsPsychHtmlButtonResponse,
	stimulus: function() {
		var FeildIdx = jsPsych.timelineVariable('FeildIdx_B');
		var Fn = jsPsych.timelineVariable('Fn_B');
		var Tag = '<img src="'+Fn+'" width="400px" id="Cue_'+FeildIdx.toString().padStart(2,'0')+'"';
		return Tag;
	},
	choices: [],
	prompt: [],
	trial_duration: 1000
};

var StartTime_ResponsePrompt = NaN;
var ResponsePrompt = {
	type: jsPsychHtmlButtonResponse,
	stimulus: function() {
		var T0 = GetFullQuestion();
		var T1 = GetSparkOptions();
		var T0T1 = T0+'<br /><br />'+T1;
		return T0T1;
	},
    choices: [],
	prompt: [],
	trial_duration: null,////////////////////////////////////////////////////////////
	on_start: function() {
		StartTime_ResponsePrompt = jsPsych.getTotalTime();
		}
};

// Specify the Response Feedback Timeline
//var TrialLoop = {
//	timeline: [ResponsePrompt,Feedback]
//};

//this bit specifies the trial loop and also makes jspych wait for the seed before running everything        
// for the trial 2,3 and 5 it takes first line of vArrayOfQs and say stimulus is timelineVaribale where its the value of A, the value of B, and then the value of C

//we make array of Qs which we're about to push the participants individual question allocation into along with the file names from ArrayofCueTags

SeedRng().then(function() {
	//Shuffle(TimelineVars);

	// specify the Trial structure ( qA, qB, SparkOptions page)
	var TrialLoop = {
		timeline: [PreTrialOps,Fixation,Show_S,Show_A,ICI,Show_B,ResponsePrompt],
		timeline_variables: TimelineVars,
		randomize_order: true,
		loop_function: function(){return true;}
	};
		

	jsPsych.run([PreloadImgs,EnterFullscreen,TrialLoop,ExitFullscreen]);
});

</script>
</head>
<body>
</body>

<!--- 


// master array of sparks
var ArrayOfImgs = [
	{FeildId:'A',CueTag:'<img src="./TestShapes/A.jpg" width="400px" id="yA">', ResponseTag: '<img src="./TestShapes/A.jpg" width="280px" id="xA" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'B',CueTag:'<img src="./TestShapes/B.jpg" width="400px" id="yB">', ResponseTag: '<img src="./TestShapes/B.jpg" width="280px" id="xB" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'C',CueTag:'<img src="./TestShapes/C.jpg" width="400px" id="yC">', ResponseTag: '<img src="./TestShapes/C.jpg" width="280px" id="xC" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'D',CueTag:'<img src="./TestShapes/D.jpg" width="400px" id="yD">', ResponseTag: '<img src="./TestShapes/D.jpg" width="280px" id="xD" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'E',CueTag:'<img src="./TestShapes/E.jpg" width="400px" id="yE">', ResponseTag: '<img src="./TestShapes/E.jpg" width="280px" id="xE" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'F',CueTag:'<img src="./TestShapes/F.jpg" width="400px" id="yF">', ResponseTag: '<img src="./TestShapes/F.jpg" width="280px" id="xF" onclick="javascript:ImgClicked(this.id)">'},
	{FeildId:'G',CueTag:'<img src="./TestShapes/G.jpg" width="400px" id="yG">', ResponseTag: '<img src="./TestShapes/G.jpg" width="280px" id="xG" onclick="javascript:ImgClicked(this.id)">'}
];

 

// now we extract the cue tags from the master array and make the question array:
var ArrayOfCueTags = ArrayOfImgs.map(function(obj){
	return obj.CueTag;
});



var ArrayOfResponseTags = ArrayOfImgs.map(function(obj){
	return obj.ResponseTag;
});


// Specify the Feedback event
var Feedback = {
	
	type: jsPsychHtmlButtonResponse,
	
	// Set the feedback to display   
	stimulus: function() {
		if(ResponseMade) {
			if(Correct){
				return '<p style="vertical-align:middle; margin: 0px 5px 30px; color:#00ff00; font-size:120px">&#10003;</p>';
			} else {
				return '<p style="vertical-align:middle; margin: 0px 5px 30px; color:#ff0000; font-size:120px">&#10060;</p>';
			}
		} else {
			return '<p style="vertical-align:middle;color:#ff0000;font-size:30px">Please try to respond on time!</p>';
		}
	},
	
	// Set the choices and prompt fields to be empty (we don't use them)
	choices: [],
	prompt: "",
    
	// Set the feedback duration (depends on whether a response was made)
	trial_duration: function() {
		if (ResponseMade) {
			return 3000;
		} else {
			return 5000;
		}
	}
};
--->
</html>